#!/bin/sh

set -o nounset   ## set -u : exit the script if you try to use an uninitialised variable
set -o errexit   ## set -e : exit the script if any statement returns a non-true return value

LSB_FAMILY=""

#############################
# Distribution detection
#############################

if [ -x "/usr/bin/apt-get" ]; then
    # Debian family
    LSB_FAMILY="debian"

elif [ -x "/bin/yum" ]; then
    # RedHat family
    LSB_FAMILY="redhat"

elif [ -x "/sbin/apk" ]; then
    # Alpine family
    LSB_FAMILY="alpine"

else
    # Unknown
    echo "ERROR: Distribution detection failed"
    exit 1
fi

#############################
# Install
#############################

case "$LSB_FAMILY" in
    debian)
        apt-install lsb-release
        ;;

    redhat)
        yum-install redhat-lsb-core
        ;;
esac

#############################
# Set distribution information
#############################

echo "Detected $LSB_FAMILY"
echo "$LSB_FAMILY" > /etc/dockerimage_distribution_family
echo "$LSB_FAMILY" > /etc/dockerimage_distribution

case "$LSB_FAMILY" in
    debian|redhat)
        lsb_release -i -s | tr '[:upper:]' '[:lower:]' > /etc/dockerimage_distribution
        lsb_release -r -s > /etc/dockerimage_distribution_version
        lsb_release -a > /etc/dockerimage_lsb_release
        ;;

    alpine)
        cat /etc/alpine-release > /etc/dockerimage_distribution_version
        ;;
esac


#############################
# Uninstall
#############################

case "$LSB_FAMILY" in
    debian)
        apt-get purge -y -f lsb-release
        ;;

    redhat)
        yum erase --assumeyes redhat-lsb-core
        yum autoremove --assumeyes
        ;;
esac
